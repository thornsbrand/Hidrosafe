{% extends "base.html" %}

{% block title %}Notificaciones - Hydrosafe{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>üì¢ Notificaciones</h2>
    <p>Aqu√≠ puedes ver alertas y mensajes importantes.</p>

    <!-- üöÄ Filtros -->
    <div class="mb-3">
        <label class="form-label">Filtrar por tipo:</label>
        <select id="filtroTipo" class="form-select" onchange="cargarNotificaciones()">
            <option value="todas">Todas</option>
            <option value="alerta">üö® Alertas de Falla</option>
            <option value="mantenimiento">üõ† Mantenimientos</option>
            <option value="admin">üìå Mensajes del Administrador</option>
        </select>
    </div>

    <ul id="notificationList" class="list-group">
        <li class="list-group-item">Cargando notificaciones...</li>
    </ul>
</div>

<script>
    function cargarNotificaciones() {
        fetch("/notifications/data")
            .then(response => response.json())
            .then(data => {
                const notificationList = document.getElementById("notificationList");
                notificationList.innerHTML = "";

                if (data.error) {
                    notificationList.innerHTML = `<li class='list-group-item text-danger'>${data.error}</li>`;
                    return;
                }

                if (data.length === 0) {
                    notificationList.innerHTML = "<li class='list-group-item'>No hay notificaciones disponibles.</li>";
                    return;
                }

                const filtro = document.getElementById("filtroTipo").value;

                data.forEach(notificacion => {
                    if (filtro !== "todas" && notificacion.tipo !== filtro) return;

                    // Formato de fecha y hora
                    const fechaCompleta = new Date(notificacion.fecha);
                    const opcionesFecha = { year: "numeric", month: "long", day: "numeric" };
                    const opcionesHora = { hour: "2-digit", minute: "2-digit", second: "2-digit" };

                    const fecha = fechaCompleta.toLocaleDateString("es-ES", opcionesFecha);
                    const hora = fechaCompleta.toLocaleTimeString("es-ES", opcionesHora);

                    // √çcono por tipo de notificaci√≥n
                    let icono = "";
                    switch (notificacion.tipo) {
                        case "alerta":
                            icono = "üö®";
                            break;
                        case "mantenimiento":
                            icono = "üõ†";
                            break;
                        case "admin":
                            icono = "üìå";
                            break;
                        default:
                            icono = "üîî";
                    }

                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex align-items-center";
                    li.innerHTML = `<span class="me-2">${icono}</span> <strong>${fecha} - ${hora}:</strong> ${notificacion.mensaje}`;
                    notificationList.appendChild(li);
                });
            })
            .catch(error => {
                console.error("Error al obtener notificaciones:", error);
                notificationList.innerHTML = "<li class='list-group-item text-danger'>Error al cargar notificaciones.</li>";
            });
    }

    document.addEventListener("DOMContentLoaded", cargarNotificaciones);
</script>
{% endblock %}
